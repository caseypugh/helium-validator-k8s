#!/bin/bash
#
# Use "scripts/deploy restart" to both deploy new config and restart pods
# Otherwise you'll want to delete and recreate the pods manually
#

cd "$(dirname "$0")"

source helper
source ../.env

CMD=$1

context=$(kubectl config current-context)
echo; echo -e "${GREEN}Deploying to $context...${NC}"

if [ -z "$NAMESPACE" ]; then
  echo "No namespace set. Defaulting to helium."
  NAMESPACE="helium"
fi

# Warn operator if we're out-of-date with our git remote
# Don't want to deploy an old version of the config on accident!
git remote update >/dev/null
UPSTREAM='@{u}'
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse "$UPSTREAM" 2>/dev/null)

if [ "$LOCAL" != "$REMOTE" ]; then
  echo "Warning, your local git checkout is not up-to-date"
  echo "Latest local commit: $LOCAL"
  echo "Latest remote commit: $REMOTE"
  [ -z "$REMOTE" ] && echo "(blank means you're in a local branch with no remote tracking branch)"

  echo
  read -r -p "Do you want to deploy anyway? [y/N] " response
  # response=${response,,} # tolower
  if [[ "$response" =~ ^(yes|y)$ ]]; then
    echo "Proceeding! YOLO"
  else
    echo "Aborting. Do a 'git pull' and try again."
    exit 1
  fi
fi

current_context=$(kubectl config current-context)
total_validators=1
if [[ "$current_context" == "$MAINNET_CLUSTER" ]]; then
  total_validators=$TOTAL_MAINNET_VALIDATORS
elif [[ "$current_context" == "$TESTNET_CLUSTER" ]]; then
  total_validators=$TOTAL_TESTNET_VALIDATORS
else
  echo "Warning, no TOTAL_*_VALIDATORS configured; defaulting to $total_validators"
  echo "Check that your .env file has all the keys from .env.sample"
fi
echo -e "Total validators: $(label $total_validators $GREEN)"
echo

namespaces=$(kubectl get namespaces)

# Automatically create the namespace if it doesn't exist
echo "Checking if $NAMESPACE namespace exists..."
if ! echo "$namespaces" | grep -q $NAMESPACE; then
  kubectl create ns $NAMESPACE
fi

hostport_namespace="dynamic-hostports"
echo "Checking if $hostport_namespace exists..."
if ! echo "$namespaces" | grep -q "$hostport_namespace"; then
  echo "Installing $hostport_namespace"
  kubectl apply -f https://raw.githubusercontent.com/0blu/dynamic-hostports-k8s/master/deploy.yaml
fi

prometheus_namespace="kube-prometheus-stack"
echo "Checking if $prometheus_namespace exists..."
if ! echo "$namespaces" | grep -q "$prometheus_namespace"; then
  ./scripts/dashboard/setup
fi

# Replace our <VALIDATOR_SETUP_SCRIPT> variable w/ contents of validator-setup.sh
validator_tpl=../k8s/validator.yml
validator_yml=../k8s/deploy.yml # tmp file
setup_script=../k8s/validator-setup.sh
setup_script_tmp=../k8s/tmp.sh

target="<VALIDATOR_SETUP_SCRIPT>"

# TODO make sure every line ends with a semicolon
# Delete any comments and newlines
grep -o '^[^#]*' $setup_script > $setup_script_tmp

# Add tab spacing to the bash script to match yml
repl=$(while IFS= read -r line; do echo -e "              $line"; done < $setup_script_tmp)

echo "Inserting validator-setup.sh into validator.yml"
while IFS= read -r line; do
  echo "${line//$target/$repl}"
done < $validator_tpl > $validator_yml

# Replace TOTAL_VALIDATORS with value from our selected environment variable
# Awkward replace command to make WSL & Mac compatible
{ rm "$validator_yml" && awk '{gsub("<TOTAL_VALIDATORS>", "'$total_validators'", $0); print}' > "$validator_yml"; } < "$validator_yml"

# Apply the new configurations
kubectl apply -f $validator_yml -n $NAMESPACE
kubectl apply -f ../k8s/exporter-service.yml -n $NAMESPACE

# Cleanup temp files
rm $validator_yml $setup_script_tmp

if [[ $CMD == "restart" ]]; then
  ./restart pod
fi

echo -e $(label "Finished!" $GREEN)
echo